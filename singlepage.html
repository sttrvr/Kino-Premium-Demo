<!doctype html>
<html lang="uz">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kino Ko'rish - Kino Premium</title>
  <meta name="description" content="Kino Premium — Film sahifasi. Treylerni ko'rish, batafsil ma'lumot va shunga o'xshash filmlar.">
  <meta name="theme-color" content="#0b0b0f">
  <link rel="canonical" href="/singlepage.html">
  <link rel="shortcut icon" href="https://img.icons8.com/ios-filled/50/FA5252/play-button-circled--v1.png" type="image/x-icon">

  <!-- Open Graph -->
  <meta property="og:type" content="video.movie">
  <meta property="og:site_name" content="Kino Premium">
  <meta property="og:title" content="Kino — Ko'rish sahifasi">
  <meta property="og:description" content="Treylerni ko'ring, ma'lumotlarni o'qing va o'xshash filmlarni toping.">
  <meta property="og:url" content="/singlepage.html">
  <meta property="og:image" content="/favicon.ico">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Kino — Ko'rish sahifasi">
  <meta name="twitter:description" content="Treylerni ko'ring, ma'lumotlarni o'qing va o'xshash filmlarni toping.">
  <meta name="twitter:image" content="/favicon.ico">

  <!-- Preconnects -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://image.tmdb.org" crossorigin>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <script src="theme.js" defer></script>
  <!-- Firebase SDKs (for global comments) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js" defer></script>
  <script src="firebase-config.js" defer></script>
  <!-- Global comments module -->
  <script src="comments.js" defer></script>
  <script src="single.js" defer></script>
  <style>
    .movie-card-big {
      display: flex;
      gap: 2.5rem;
      align-items: flex-start;
      background: var(--surface2, #18181c);
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
      padding: 2.5rem 2rem;
      margin: 2rem 0;
      flex-wrap: wrap;
    }

    .movie-card-img img {
      width: 260px;
      max-width: 100%;
      border-radius: 1rem;
    }

    .movie-card-info {
      flex: 1 1 320px;
      min-width: 260px;
    }

    .movie-card-title {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .movie-card-meta {
      color: #ffb300;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      display: flex;
      gap: 1.2rem;
      flex-wrap: wrap;
    }

    .movie-card-desc {
      font-size: 1.08rem;
      color: #ddd;
      margin-bottom: 1.5rem;
    }

    .movie-card-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    @media (max-width:700px) {
      .movie-card-big {
        flex-direction: column;
        padding: 1.2rem 0.5rem;
      }

      .movie-card-img img {
        width: 100%;
        max-width: 320px;
        margin: 0 auto;
        display: block;
      }

      .movie-player iframe {
        height: 260px;
      }
    }

    .movie-player {
      margin-top: 2rem;
      border-radius: 1rem;
      overflow: hidden;
      background: #000;
    }

    .movie-player iframe {
      width: 100%;
      height: 500px;
      display: block;
    }

    /* Star rating styles */
    .star-rating { display: inline-flex; gap: 6px; align-items: center; user-select: none; }
    .star-rating .star {
      width: 28px; height: 28px; border: none; background: transparent; cursor: pointer; color: #666;
      font-size: 26px; line-height: 1; padding: 0; transition: transform 0.15s ease, color 0.15s ease;
    }
    .star-rating .star:hover { transform: scale(1.1); }
    .star-rating .star.active, .star-rating .star.filled { color: #ffb300; }
    .rating-hint { color: var(--muted); font-size: 0.9rem; margin-left: 8px; }

    /* Similar movies horizontal scroller */
    #similarSection { margin: 2rem 0; }
    #similarGrid {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding: 0.25rem 0.25rem 0.75rem;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      cursor: grab;
    }
    #similarGrid::-webkit-scrollbar { height: 8px; }
    #similarGrid::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); border-radius: 8px; }
    #similarGrid .movie-card { min-width: 180px; max-width: 220px; scroll-snap-align: start; }
    #similarGrid.dragging { cursor: grabbing; }
    @media (max-width: 768px) {
      #similarGrid .movie-card { min-width: 160px; }
    }

    .sim-nav {
      position: relative;
    }
    .sim-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 40px; height: 40px;
      border-radius: 50%; border: none;
      background: rgba(0,0,0,0.45);
      color: #fff; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      z-index: 5;
    }
    #simPrev { left: -10px; }
    #simNext { right: -10px; }
    @media (max-width: 768px) {
      #simPrev { left: 0; }
      #simNext { right: 0; }
    }
  </style>
</head>

<body>
  <!-- Yuklash animatsiyasi -->
  <div class="loader-container" id="loader">
    <div class="loader"></div>
  </div>
  
  <div id="app" class="app">
    <header class="site-header">
      <div class="container header-inner">
        <a href="/" class="logo">
          <div class="logo-icon">
            <i class="fas fa-play-circle"></i>
          </div>
          <span class="logo-text">KINO<span class="logo-premium">PREMIUM</span></span>
        </a>

        <nav class="main-nav">
          <ul class="nav-list">
            <li><a href="" class="nav-link active" data-filter="popular" id="navPopular"><i
                  class="fas fa-fire"></i>Kino</a></li>
            <li><a href="index.html" class="nav-link" data-filter="now_playing" id="navNowPlaying"><i
                  class="fas fa-film"></i> Kinolar</a></li>
            <li><a href="singlepage.html#top" class="nav-link" id="navTopRated"><i class="fas fa-star"></i> Top</a></li>
          </ul>
        </nav>

        <div class="header-actions">
          <form id="searchForm" class="search-form">
            <div class="search-input-wrapper">
              <input id="searchInput" name="q" type="search" placeholder="Film qidiring..." />
              <button type="submit"><i class="fas fa-search"></i></button>
            </div>
          </form>
          <button id="themeToggle" class="btn icon-btn" aria-label="Rejimni almashtirish" aria-pressed="false" title="Light/Dark">
            <i class="fas fa-moon"></i>
          </button>
        </div>

        <button class="mobile-menu-toggle">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </header>

    <main class="main">
      <div class="container">
        <section id="videoPage" class="video-page active">
          <div class="movie-card-big" id="singleMovieCard">
            <div class="movie-card-img">
              <img id="moviePoster" src="" alt="Poster" />
            </div>
            <div class="movie-card-info">
              <h1 id="movieTitle" class="movie-card-title"></h1>
              <div class="movie-card-meta">
                <span id="movieYear"></span>
                <span id="movieRating"></span>
                <span id="movieGenres"></span>
              </div>
              <div class="movie-player">
                <iframe id="moviePlayer" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="no-referrer-when-downgrade" loading="lazy" allowfullscreen></iframe>
              </div>
              <p id="movieDescription" class="movie-card-desc"></p>
              <div id="movieMoreMeta" class="movie-card-meta" style="color:var(--muted);gap:0.75rem"></div>
              <div class="movie-card-actions">
                <a class="btn primary" id="trailerBtn" target="_blank" rel="noopener">
                  <i class="fas fa-film"></i> Treylerni ko'rish
                </a>
                <button id="singleFavBtn" class="btn icon-btn" aria-pressed="false" aria-label="Sevimlilarga qo'shish">
                  <i class="far fa-heart"></i>
                </button>
                <button id="backButton" class="btn ghost">
                  <i class="fas fa-arrow-left"></i> Orqaga
                </button>
              </div>

              <hr style="margin:1rem 0;border-color:rgba(255,255,255,0.1)">

              <section id="reviewsSectionSingle" aria-label="Sharh va reyting">
                <h3 style="margin-bottom:0.5rem">Sharh va reyting</h3>
                <form id="reviewFormSingle" class="auth-form" style="margin:0 0 1rem 0">
                  <div class="form-row">
                    <label>Reyting</label>
                    <div id="starRating" class="star-rating" aria-label="Yulduzcha bilan baholang" role="radiogroup">
                      <button type="button" class="star" data-value="1" aria-label="1 yulduz">★</button>
                      <button type="button" class="star" data-value="2" aria-label="2 yulduz">★</button>
                      <button type="button" class="star" data-value="3" aria-label="3 yulduz">★</button>
                      <button type="button" class="star" data-value="4" aria-label="4 yulduz">★</button>
                      <button type="button" class="star" data-value="5" aria-label="5 yulduz">★</button>
                      <span id="ratingHint" class="rating-hint">Reytingni tanlang</span>
                    </div>
                  </div>
                  <button type="submit" class="btn primary"><i class="fas fa-star"></i> Yuborish</button>
                </form>
                <!-- Local reviews list removed as requested; using global comments below -->
              </section>

              <hr style="margin:1rem 0;border-color:rgba(255,255,255,0.1)">
              <section id="commentsSection" aria-label="Foydalanuvchi izohlari" style="margin-top:1rem">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                  <h3 style="margin:0">Izohlar</h3>
                  <button id="pinMyCommentBtn" class="btn ghost" type="button" title="Oxirgi izohingizni yuqoriga mahkamlash (Admin)"><i class="fas fa-thumbtack"></i> Mening izohimni pinla</button>
                </div>
                <form id="commentForm" class="auth-form" style="margin:0 0 1rem 0">
                  <div class="form-row">
                    <label for="commentName">Ism (ixtiyoriy)</label>
                    <input id="commentName" type="text" placeholder="Ismingiz">
                  </div>
                  <div class="form-row">
                    <label for="commentText">Izoh</label>
                    <textarea id="commentText" rows="3" placeholder="Fikringizni yozing..." style="resize:vertical;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:var(--text);border-radius:10px;padding:0.6rem 0.75rem" required></textarea>
                  </div>
                  <button type="submit" class="btn primary"><i class="fas fa-comment"></i> Yuborish</button>
                </form>
                <ul id="commentsList" style="display:flex;flex-direction:column;gap:0.75rem;padding-left:0"></ul>
              </section>
            </div>
          </div>

          <section id="similarSection" style="margin:2rem 0">
            <h3 class="section-title" style="margin-bottom:1rem">O'xshash filmlar</h3>
            <div class="sim-nav">
              <button id="simPrev" class="sim-btn" aria-label="Oldingi"><i class="fas fa-chevron-left"></i></button>
              <ul id="similarGrid" class="movies-grid"></ul>
              <button id="simNext" class="sim-btn" aria-label="Keyingi"><i class="fas fa-chevron-right"></i></button>
            </div>
          </section>
          
          <script>
          // Sahifa yuklanganda ishga tushuvchi kod
          document.addEventListener('DOMContentLoaded', async function() {
            try {
              // Film ma'lumotlarini yuklash
              const response = await fetch('movies.json');
              const movies = await response.json();
              
              // localStorage dan film ID ni olish
              const movieId = localStorage.getItem('selectedMovieId');
              
              if (!movieId) {
                console.error('Film ID topilmadi!');
                hideLoader();
                return;
              }

            // Prev/Next buttons for similar scroller
            function initSimilarNav() {
              const scroller = document.getElementById('similarGrid');
              const prev = document.getElementById('simPrev');
              const next = document.getElementById('simNext');
              if (!scroller || !prev || !next) return;
              const getStep = () => {
                const card = scroller.querySelector('.movie-card');
                if (!card) return 240; // default step
                const style = window.getComputedStyle(card);
                const w = card.getBoundingClientRect().width + parseFloat(style.marginLeft) + parseFloat(style.marginRight);
                return Math.max(160, Math.min(320, w));
              };
              prev.onclick = (e) => {
                e.preventDefault(); scroller.scrollBy({ left: -getStep(), behavior: 'smooth' });
              };
              next.onclick = (e) => {
                e.preventDefault(); scroller.scrollBy({ left: +getStep(), behavior: 'smooth' });
              };
            }
              
              // Film ma'lumotlarini topish
              const movie = movies.find(m => m.id == movieId);
              
              if (movie) {
                // Film ma'lumotlarini sahifaga joylashtirish
                const titleEl = document.querySelector('#movieTitle');
                const yearEl = document.querySelector('#movieYear');
                const typeEl = document.querySelector('#movieGenres');
                const durationEl = document.querySelector('#movieDescription');
                const posterEl = document.querySelector('#moviePoster');
                
                if (titleEl) titleEl.textContent = movie.name || 'Nomsiz film';
                if (yearEl) yearEl.textContent = movie.year || 'N/A';
                if (typeEl) typeEl.textContent = movie.type || 'Film';
                if (durationEl) durationEl.textContent = (movie.duration || '120') + ' min';
                if (posterEl && movie.poster_img) posterEl.src = movie.poster_img;
              } else {
                console.error('Film topilmadi!');
              }
              // === TMDB integratsiya: topish va render qilish ===
              try {
                const titleNorm = movie.name || movie.title || movie.primaryTitle || '';
                const yearNorm = movie.year || (movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : '');
                let tmdbId = movie.tmdb_id;
                let tmdbPrimary = null;
                if (!tmdbId) {
                  const found = await fetchTmdbByTitle(titleNorm, yearNorm);
                  if (found) tmdbId = found.id;
                }
                if (tmdbId) {
                  tmdbPrimary = await fetchTmdbDetails(tmdbId);
                  const moreMetaEl = document.getElementById('movieMoreMeta');
                  renderCredits(moreMetaEl, tmdbPrimary.details, tmdbPrimary.credits);
                }

                // Similar (always try to render from TMDB first, then fallback to local)
                const simGrid = document.getElementById('similarGrid');
                const simSection = document.getElementById('similarSection');
                if (simGrid) {
                  simGrid.innerHTML = '';
                  let list = Array.isArray(tmdbPrimary?.similar) ? tmdbPrimary.similar.slice(0, 20) : [];
                  // Render TMDB similar
                  list.forEach(s => simGrid.appendChild(createSimilarCard(s)));

                  // Fallback to local JSON by category intersection if TMDB similar is empty
                  if (!simGrid.children.length && Array.isArray(movies)) {
                    const baseCats = Array.isArray(movie.category) ? movie.category.map(String) : [];
                    const candidates = movies.filter(m => String(m.id) !== String(movieId));
                    const scored = candidates.map(m => {
                      const cats = Array.isArray(m.category) ? m.category.map(String) : [];
                      const score = cats.filter(c => baseCats.includes(c)).length;
                      return { m, score };
                    }).filter(x => x.score > 0).sort((a,b) => b.score - a.score);
                    const pick = scored.slice(0, 20).map(x => x.m);
                    pick.forEach(mm => {
                      const li = document.createElement('li');
                      li.className = 'movie-card';
                      const title = mm.name || mm.title || '';
                      const year = mm.year || '';
                      const rating = mm.vote_average ? Number(mm.vote_average).toFixed(1) : 'N/A';
                      const poster = mm.poster_img || mm.image || (mm.poster_path ? `https://image.tmdb.org/t/p/w500${mm.poster_path}` : 'https://via.placeholder.com/300x450/1a1a1a/ffffff?text=No+Image');
                      li.innerHTML = `
                        <div class="poster-wrap">
                          <img src="${poster}" alt="${title}" loading="lazy" decoding="async" width="300" height="450">
                        </div>
                        <div class="movie-info">
                          <h4>${title}</h4>
                          <div class="meta">${year} • ⭐ ${rating}</div>
                        </div>`;
                      li.addEventListener('click', () => {
                        localStorage.setItem('selectedMovieId', mm.id);
                        location.reload();
                      });
                      simGrid.appendChild(li);
                    });
                  }
                  if (simSection) simSection.style.display = simGrid.children.length ? '' : 'none';
                  initSimilarDrag();
                  initSimilarNav();
                }
              } catch (tmdbErr) {
                console.debug('TMDB fetch skipped:', tmdbErr);
              }
            } catch (error) {
              console.error('Xatolik yuz berdi:', error);
            } finally {
              // Yuklash animatsiyasini yashirish
              hideLoader();
            }
          });
          
          // Yuklash animatsiyasini yashirish
          function hideLoader() {
            const loader = document.getElementById('loader');
            if (loader) {
              loader.classList.add('loader-hidden');
              setTimeout(() => {
                loader.style.display = 'none';
              }, 500);
            }
          }
            // === TMDB details & similar ===
            const API_KEY = '1cc4799e6c8448e51c96a232c8ec4b18';
            const API_URL = 'https://api.themoviedb.org/3';
            function normalizeTitle(m) { return m.primaryTitle || m.title || m.name || ''; }
            async function fetchTmdbByTitle(title, year) {
              try {
                const url = `${API_URL}/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(title)}${year ? `&year=${year}` : ''}&language=uz-UZ&region=UZ&page=1`;
                const res = await fetch(url);
                const data = await res.json();
                return (data.results || [])[0] || null;
              } catch { return null; }
            }
            async function fetchTmdbDetails(id) {
              const [details, credits, similar] = await Promise.all([
                fetch(`${API_URL}/movie/${id}?api_key=${API_KEY}&language=uz-UZ`).then(r=>r.json()).catch(()=>null),
                fetch(`${API_URL}/movie/${id}/credits?api_key=${API_KEY}&language=uz-UZ`).then(r=>r.json()).catch(()=>null),
                fetch(`${API_URL}/movie/${id}/similar?api_key=${API_KEY}&language=uz-UZ&region=UZ&page=1`).then(r=>r.json()).catch(()=>null)
              ]);
              return { details, credits, similar: (similar && similar.results) || [] };
            }
            function renderCredits(metaEl, details, credits) {
              if (!metaEl) return;
              const parts = [];
              if (details && (details.runtime || details.original_language || details.vote_average)) {
                if (details.runtime) parts.push(`${details.runtime} min`);
                if (details.original_language) parts.push(`Til: ${details.original_language.toUpperCase()}`);
                if (details.vote_average) parts.push(`IMDB ⭐ ${Number(details.vote_average).toFixed(1)}`);
              }
              if (credits && Array.isArray(credits.crew)) {
                const dir = credits.crew.find(c => c.job === 'Director');
                if (dir) parts.push(`Rejissyor: ${dir.name}`);
              }
              if (credits && Array.isArray(credits.cast)) {
                const topCast = credits.cast.slice(0, 5).map(c => c.name).join(', ');
                if (topCast) parts.push(`Aktyorlar: ${topCast}`);
              }
              metaEl.textContent = parts.join(' • ');
            }
            function createSimilarCard(m) {
              const li = document.createElement('li');
              li.className = 'movie-card';
              const title = m.title || m.name || '';
              const year = (m.release_date ? new Date(m.release_date).getFullYear() : '') || '';
              const rating = typeof m.vote_average === 'number' ? m.vote_average.toFixed(1) : 'N/A';
              const poster = m.poster_path ? `https://image.tmdb.org/t/p/w500${m.poster_path}` : 'https://via.placeholder.com/300x450/1a1a1a/ffffff?text=No+Image';
              li.innerHTML = `
                <div class="poster-wrap">
                  <img src="${poster}" alt="${title}" loading="lazy" decoding="async" width="300" height="450">
                </div>
                <div class="movie-info">
                  <h4>${title}</h4>
                  <div class="meta">${year} • ⭐ ${rating}</div>
                </div>`;
              li.addEventListener('click', (e) => {
                if (window.__similarDraggingActive) { e.preventDefault(); return; }
                // Save this TMDB movie id as selected and go back to the same page
                localStorage.setItem('selectedMovieId', m.id);
                location.reload();
              });
              return li;
            }
            // Drag-to-scroll for similar grid (mouse)
            function initSimilarDrag() {
              const scroller = document.getElementById('similarGrid');
              if (!scroller) return;
              let isDown = false; let startX = 0; let scrollLeft = 0; let moved = false;
              scroller.addEventListener('mousedown', (e) => {
                isDown = true; moved = false; window.__similarDraggingActive = false;
                scroller.classList.add('dragging');
                startX = e.pageX - scroller.offsetLeft;
                scrollLeft = scroller.scrollLeft;
              });
              scroller.addEventListener('mouseleave', () => { isDown = false; scroller.classList.remove('dragging'); window.__similarDraggingActive = false; });
              scroller.addEventListener('mouseup', () => { isDown = false; scroller.classList.remove('dragging'); setTimeout(()=>{ window.__similarDraggingActive = false; }, 50); });
              scroller.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - scroller.offsetLeft;
                const walk = (x - startX) * 1; // speed factor
                if (Math.abs(walk) > 3) { moved = true; window.__similarDraggingActive = true; }
                scroller.scrollLeft = scrollLeft - walk;
              });
              // Optional: Shift + wheel for horizontal scroll on desktop mice
              scroller.addEventListener('wheel', (e) => {
                if (Math.abs(e.deltaX) < Math.abs(e.deltaY)) {
                  scroller.scrollLeft += e.deltaY;
                  e.preventDefault();
                }
              }, { passive: false });
            }
          </script>
          <script>
            // === Reviews on single page (star-based) -> submit to global Comments ===
            document.addEventListener('DOMContentLoaded',()=>{
              const mid=Number(localStorage.getItem('selectedMovieId'))||0;
              // Star rating logic
              let selected=0; const stars=Array.from(document.querySelectorAll('#starRating .star')); const hint=document.getElementById('ratingHint');
              function paint(n){stars.forEach(s=>{const v=Number(s.dataset.value); s.classList.toggle('filled', v<=n); s.classList.toggle('active', v<=n);}); if(hint) hint.textContent = n?`Reyting: ${n}/5`:'Reytingni tanlang';}
              stars.forEach(s=>{
                s.addEventListener('mouseenter',()=>paint(Number(s.dataset.value)));
                s.addEventListener('mouseleave',()=>paint(selected||0));
                s.addEventListener('click',()=>{selected=Number(s.dataset.value)||0; paint(selected||0);});
              });
              paint(0);
              const form=document.getElementById('reviewFormSingle');
              if(form){form.addEventListener('submit',async (e)=>{
                e.preventDefault();
                const rating=selected||0;
                if(!rating){ if(hint){hint.textContent='Iltimos, reytingni tanlang';} return; }
                try {
                  if (window.Comments && mid) {
                    // Use optional name from comments section if present
                    const name = (document.getElementById('commentName')?.value || '').trim();
                    const res = await window.Comments.add(mid, { name, text: `Reyting: ${rating}/5`, pinned: true, admin: true });
                    // Fallback: ensure pinned even if provider ignored flags
                    if (res && res.id) {
                      await window.Comments.pin(mid, res.id, { pinned: true, admin: true });
                    }
                  }
                } finally {
                  selected=0; paint(0);
                }
              });}
            });
          </script>
        </section>
      </div>
    </main>

    <footer class="site-footer">
      <div class="footer-gradient-flow"></div>
      <div class="container footer-inner">
        <div class="footer-content">
          <div class="footer-brand">
            <div class="logo"><i class="fas fa-play-circle icon rotate"></i>KINO<span
                class="logo-premium">PREMIUM</span></div>
            <p>Eng yangi va eng yaxshi filmlar faqat bizda</p>
          </div>

          <div class="footer-links">
            <div class="footer-column">
              <h4>Havolalar</h4>
              <a href="#">Bosh sahifa</a>
              <a href="#">Filmlar</a>
              <a href="#">Seriallar</a>
              <a href="#">Yangi qo'shilganlar</a>
            </div>
            <div class="footer-column">
              <h4>Hisob</h4>
              <a href="#">Profil</a>
              <a href="#">Sevimlilar</a>
              <a href="#">Tarix</a>
              <a href="#">Sozlamalar</a>
            </div>
            <div class="footer-column">
              <h4>Yordam</h4>
              <a href="#">FAQ</a>
              <a href="#">Qo'llab-quvvat</a>
              <a href="#">Shartlar</a>
              <a href="#">Maxfiylik</a>
            </div>
          </div>

          <div class="footer-social">
            <h4>Bizni kuzatib boring</h4>
            <div class="social-icons">
              <a href="#" class="icon bounce"><i class="fab fa-telegram"></i></a>
              <a href="#" class="icon bounce"><i class="fab fa-instagram"></i></a>
              <a href="#" class="icon bounce"><i class="fab fa-youtube"></i></a>
              <a href="#" class="icon bounce"><i class="fab fa-twitter"></i></a>
            </div>
          </div>
        </div>

        <div class="footer-bottom">
          <p>© <span id="year"></span> Kino Premium. Barcha huquqlar himoyalangan.</p>
          <nav class="footer-nav">
            <a href="privacy.html">Maxfiylik siyosati</a>
            <a href="terms.html">Foydalanish shartlari</a>
          </nav>
        </div>
      </div>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const movieId = localStorage.getItem('selectedMovieId');
        if (!movieId) throw new Error('selectedMovieId topilmadi. Index sahifadan "Ko\'rish" tugmasi bilan tanlang.');

        let moviesList = Array.isArray(window.movies) ? window.movies : [];
        if (!moviesList.length) {
          const res = await fetch('movies.json');
          if (!res.ok) throw new Error('movies.json yuklanmadi, status=' + res.status);
          moviesList = await res.json();
        }

        const movie = moviesList.find(m => String(m.id) === String(movieId));
        if (!movie) throw new Error('Tanlangan film topilmadi: id=' + movieId);

        const posterEl = document.getElementById('moviePoster');
        const titleEl = document.getElementById('movieTitle');
        const yearEl = document.getElementById('movieYear');
        const ratingEl = document.getElementById('movieRating');
        const genresEl = document.getElementById('movieGenres');
        const descEl = document.getElementById('movieDescription');
        const trailerBtn = document.getElementById('trailerBtn');
        const backBtn = document.getElementById('backButton');
        const playerEl = document.getElementById('moviePlayer');
        const singleFavBtn = document.getElementById('singleFavBtn');

        const title = movie.primaryTitle || movie.title || movie.name || '';
        const poster = movie.primaryImage || movie.poster_img || (movie.poster_path ? 'https://image.tmdb.org/t/p/w500' + movie.poster_path : '');
        const year = movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : (movie.year || '');
        const rating = movie.averageRating ?? movie.vote_average ?? '';
        const genres = Array.isArray(movie.genres) ? movie.genres.join(', ') : (movie.genres || movie.type || '');
        const description = movie.description || movie.details || movie.overview || '';
        const trailerUrl = movie.trailer || movie.video || movie.trailerUrl || movie.videoUrl || '';

        posterEl.src = poster || '';
        posterEl.alt = title || 'Poster';
        posterEl.loading = 'lazy';
        posterEl.decoding = 'async';
        posterEl.width = 300;
        posterEl.height = 450;
        if (movie.poster_path) {
          const p = movie.poster_path;
          posterEl.srcset = `https://image.tmdb.org/t/p/w185${p} 185w, https://image.tmdb.org/t/p/w342${p} 342w, https://image.tmdb.org/t/p/w500${p} 500w`;
          posterEl.sizes = '(max-width: 480px) 60vw, (max-width: 768px) 40vw, 300px';
        } else {
          posterEl.removeAttribute('srcset');
          posterEl.removeAttribute('sizes');
        }
        titleEl.textContent = title || 'Noma\'lum film';
        yearEl.textContent = year || '';
        ratingEl.textContent = rating ? '⭐ ' + rating : '';
        genresEl && (genresEl.textContent = genres || '');
        descEl.textContent = description || '';

        if (trailerUrl) {
          const fullUrl = trailerUrl.startsWith('//') ? location.protocol + trailerUrl : trailerUrl;
          trailerBtn.href = fullUrl;
          playerEl.src = fullUrl;
        } else {
          trailerBtn.style.display = 'none';
          playerEl.style.display = 'none';
        }

        // Update SEO meta tags dynamically
        const setMeta = (selector, attr, value) => {
          let el = document.querySelector(selector);
          if (!el) {
            el = document.createElement('meta');
            const [key, val] = selector.includes('property') ? ['property', selector.match(/property=\"([^\"]+)/)[1]] : ['name', selector.match(/name=\"([^\"]+)/)[1]];
            el.setAttribute(key, val);
            document.head.appendChild(el);
          }
          el.setAttribute(attr, value);
        };
        const shareImg = poster || '/favicon.ico';
        const pageUrl = location.origin + location.pathname;
        setMeta('meta[property="og:title"]', 'content', title);
        setMeta('meta[property="og:description"]', 'content', description || '');
        setMeta('meta[property="og:image"]', 'content', shareImg);
        setMeta('meta[property="og:url"]', 'content', pageUrl);
        setMeta('meta[name="twitter:title"]', 'content', title);
        setMeta('meta[name="twitter:description"]', 'content', description || '');
        setMeta('meta[name="twitter:image"]', 'content', shareImg);

        backBtn.addEventListener('click', () => {
          localStorage.removeItem('selectedMovieId');
          window.location.href = 'index.html';
        });

        // Favorites toggle on single page
        try {
          const rawFav = JSON.parse(localStorage.getItem('favorites') || '[]');
          const favs = Array.isArray(rawFav) ? rawFav.map(Number) : [];
          const mid = Number(movie.id);
          const isFav = favs.includes(mid);
          singleFavBtn.setAttribute('aria-pressed', String(isFav));
          singleFavBtn.querySelector('i').className = (isFav ? 'fas' : 'far') + ' fa-heart';
          singleFavBtn.addEventListener('click', () => {
            const idx = favs.indexOf(mid);
            if (idx === -1) favs.push(mid); else favs.splice(idx, 1);
            localStorage.setItem('favorites', JSON.stringify(favs));
            const nowFav = favs.includes(mid);
            singleFavBtn.setAttribute('aria-pressed', String(nowFav));
            singleFavBtn.querySelector('i').className = (nowFav ? 'fas' : 'far') + ' fa-heart';
          });
        } catch {}

        console.log('Film muvaffaqiyatli yuklandi:', title);
      } catch (err) {
        console.error('Singlepage init error:', err);
        alert('Xatolik: ' + err.message);
      }
      // Mount global comments UI
      try {
        const mid = Number(localStorage.getItem('selectedMovieId')) || 0;
        if (mid && window.Comments) {
          window.Comments.mountSinglePage({
            movieId: mid,
            formEl: document.getElementById('commentForm'),
            nameInput: document.getElementById('commentName'),
            textInput: document.getElementById('commentText'),
            listEl: document.getElementById('commentsList')
          });
          // Pin my comment (admin)
          const pinBtn = document.getElementById('pinMyCommentBtn');
          if (pinBtn) {
            pinBtn.addEventListener('click', () => {
              const name = (document.getElementById('commentName')?.value || '').trim();
              let unsub = null;
              unsub = window.Comments.subscribe(mid, async (list) => {
                try {
                  const target = (name ? list.find(x => (x.name||'').trim() === name) : list[0]) || null;
                  if (target && target.id) {
                    await window.Comments.pin(mid, target.id, { pinned: true, admin: true });
                    alert('Izoh pin qilindi va Admin belgilandi.');
                  } else {
                    alert('Izoh topilmadi. Avval izoh yozing yoki ismingizni kiriting.');
                  }
                } finally {
                  if (typeof unsub === 'function') unsub();
                }
              });
            });
          }
        }
      } catch(e){ console.debug('Comments init skipped', e); }
    });
  </script>
  <script>
    // Service Worker registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('sw.js').catch(function (err) {
          console.debug('SW register failed:', err);
        });
      });
    }
  </script>
</body>

</html>
